---
title: Introduction to TVTB
author:
    -   name: KÃ©vin Rue-Albrecht
        email: k.rue-albrecht@imperial.ac.uk
        affiliation: Department of Medicine, Imperial College London,
            Hammersmith Campus, Du Cane Road, London, W12 0NN, UK
date: "`r doc_date()`"
package: "`r pkg_ver('TVTB')`"
abstract:
    The Variant Tool-Box (*TVTB*) provides functions to summarise and
    visualise gene-centric genetic variation data stored in VCF files
    pre-processed by the Ensembl Variant Effect Predictor (VEP).
    A Shiny web-application, the Shiny Variant Explorer (tSVE),
    provides a convenient interface to demonstrate
    those functionalities in a programming-free environment.
vignette: >
    %\VignetteIndexEntry{Introduction to TVTB}
    %\VignetteEngine{knitr::rmarkdown}
    %\VignetteEncoding{UTF-8}
output: 
    BiocStyle::pdf_document2
bibliography:
    Introduction.bib
---

# Introduction

The Variant Tool-Box (`r Biocpkg("TVTB")`[^1]) offers functions
to summarise and visualise gene-centric genetic variation data
stored in VCF files pre-processed by the
Ensembl Variant Effect Predictor (VEP) [@RN1].
A Shiny web-application, the Shiny Variant Explorer (tSVE),
provides a convenient interface to demonstrate those
functionalities in a programming-free environment.

[^1]: See also: *ti voglio tanto bene* (Italian).

# Installation

The Variant Tool-Box can be installed using the following code:

```{r biocLite, eval=FALSE}
source("http://bioconductor.org/biocLite.R")
biocLite("TVTB")
```

Once installed, the package can be loaded and attached as follows:

```{r library, message=FALSE}
library(TVTB)
```

# Recurrent settings: TVTBparam

Many functionalities in `r Biocpkg("TVTB")` require recurrent information
such as:

* genotypes (homozygote reference, heterozygote, homozygote alternate)
* INFO field containing the Ensembl VEP predictions in the VCF file
* suffixes of INFO fields where counts and frequencies of genotypes are stored
    + counts and frequencies may be calculated for levels of phenotypes,
        in which case the corresponding INFO fields are formed as
        `<phenotype>_<level>_<suffix>`
    + counts and frequencies across all samples are stored in INFO fields
        simply named `<suffix>`
* settings for parallel calculations

To reduce the burden of repetitive programming, and to 
facilitate analyses using consistent sets of parameters,
`r Biocpkg("TVTB")` implements the `TVTBparam` class.
`TVTBparam` objects offer a container for parameters recurrently used across
the package.
A `TVTBparam` object may be initialised as follows:

```{r TVTBparamCreate}
tparam <- TVTBparam(
    genos = list(
        REF = c("0|0"),
        HET = c("0|1", "1|0"),
        ALT = c("1|1")),
    ranges = GenomicRanges::GRanges(
        seqnames = "15",
        IRanges::IRanges(
            start = 48413170, end = 48434757, names = "SLC24A5")),
    aaf = "AAF", # default
    maf = "MAF", # default
    vep = "CSQ", # default
    bp = BiocParallel::SerialParam()) # default
```
\fixme{
In the future, add a second region to the `ranges` slot, to demonstrate
relevant features (e.g. plots faceted by range).
}

`TVTBparam` objects have a convenient summary view:

```{r TVTBparamView}
tparam
```

In this example:

* **Genotypes**
    + homozygote reference genotype is encoded `0|0`
        - counts of genotypes are stored in INFO fields suffixed with `REF`
    + heterozygote genotypes are encoded either `0|1` or `1|0`
        - counts of genotypes are stored in INFO fields suffixed with `HET`
    + homozygote alternate  genotype is encoded `1|1`
        - counts of genotypes are stored in INFO fields suffixed with `ALT`
* **Genomic ranges**
    + a gene-coding region on chromosome 15
* **Alternate allele frequency**
    + stored in INFO fields suffixed with `AAF`
* **Minor allele frequency**
    + stored in INFO fields suffixed with `MAF`
* **Ensembl VEP predictions**
    + imported from INFO field `CSQ`
* **Parallel calculations**
    + turned off. Serial calculations are performed.

Default values are provided for all slots except genotypes, as these may vary
more frequently from one data set to another.
\bioccomment{
In the future, however, a small set of pre-configured `TVTBparam` objects
may be included in the package for the most common situations
(e.g., `TVTBparamPhased`, `TVTBparamUnphased`, `TVTBparam012`).
}

# Data import

## Variants and phenotypes

Functionalities in `r Biocpkg("TVTB")` currently only support
`ExpandedVCF` objects of the `r Biocpkg("VariantAnnotation")` package,
that encode a single alternate allele per record.
`ExpandedVCF` objects may be produced:

* from a VCF file
using the `r Biocpkg("VariantAnnotation")` `readVcf()` method
with argument `collapsed=FALSE`,
* from `r Biocpkg("VariantAnnotation")` `CollapsedVCF` objects
using the `r Biocpkg("VariantAnnotation")` `expand()` method.

To enable the key functionalities of the `r Biocpkg("TVTB")` package, the
`ExpandedVCF` object should include at least the following information:

* `fixed(x)`
    + `ALT`: alternate allele(s)
    
* `info(x)`
    + `<vep>`: where `<vep>` stands for a user-defined INFO field that
        contains Ensembl VEP predictions
    
* `geno(x)`
    + `GT`: genotypes

* `colData(x)`: phenotypes

## The preprocessVariants() method

The `r Biocpkg("TVTB")` method `preprocessVariants` offers an integrated route
to produce a minimal `ExpandedVCF` object that contains all the data
necessary for subsequent analyses.
To initialise a minimal `ExpandedVCF` object,
the `preprocessVariants` method imports:

* phenotypes
    + in any of the following formats:
        - `DataFrame` from the `r Biocpkg("S4Vectors")` package
        - `data.frame`
        -  text file
    + in all cases, phenotypes must include:
        - `rownames`: sample identifiers
        - `colnames`: phenotype names
* variants within given genomic region(s)
    + `CHROM`, `POS`, `REF`, `ALT` fixed fields
    + Ensembl VEP predictions from a given INFO field for the above variants
        - Default: `CSQ`
    + genotypes (`GT`) for samples identified in the above phenotypes
        `rownames`
        - if no phenotypes are given, all samples are imported from the VCF
            file
    
The imported variants are expanded into bi-allelic records
(*i.e.,* one reference allele and one alternate allele per record),
and phenotypes are combined as the `colData` of the resulting `ExpandedVCF`
object.

## Example

Using the sample files included in the package, an `ExpandedVCF` object
can be obtained as follows:

```{r preprocessVariants, message=FALSE}
# Import phenotypes ----
phenoFile <- system.file(
    "extdata/integrated_samples.txt",
    package = "TVTB")

# Define VCF file ----
vcfFile <- system.file(
    "extdata/chr15.phase3_integrated.vcf.gz",
    package = "TVTB")

tabixVcf <- Rsamtools::TabixFile(file = vcfFile)

# Import variants and phenotypes ----
vcf <- preprocessVariants(
    file = tabixVcf,
    param = tparam,
    phenos = phenoFile)
```

\bioccomment{
For `preprocessVariants`, `TVTBparam` objects are used
only for the `vep` slot, that defines the INFO field
in which the Ensembl VEP predictions are stored.
}

The result is an `ExpandedVCF` object including 481 variants in 2,504 samples:

```{r vcf, echo=FALSE}
vcf
```

# Summarising Ensembl VEP predictions

Although later sections discuss:

* the calculation of additional `info` fields (\fixme{Coming soon!}) 
* the filtering of variants based on `fixed`, `info`, and `geno` fields
    (\fixme{Coming soon!})

interesting figures and summary tables may be obtained as soon as the first
`ExpandedVCF` object is created.

Currently, major `r Biocpkg("TVTB")` functionalities include:

* Counting discrete Ensembl VEP predictions in levels of a phenotype
    + as a `data.frame` or a stacked `r Biocpkg("ggplot2") `geom_bar`
    + counts faceted by another Ensembl VEP prediction (*e.g.* Feature)
    + `geom_bar` represented as stacked *percentage* of predictions
* Density distribution of continuous Ensembl VEP predictions in levels of
    a phenotype
    + density faceted by another Ensembl VEP prediction
* Adding genotype counts and allele frequencies to the `ExpandedVCF` object
    + counts and frequencies within level(s) of phenotype(s)
    + overall counts and frequencies (*i.e.* across all samples)
* Subset `ExpandedVCF` objects using a combination of filters on data in
    the `fixed` data, `info` data, and Ensembl VEP preditions

## Counts of discrete Ensembl VEP predictions

### Barplot

The following chunk of code displays,
for each genomic feature affected,
the count of each Ensembl VEP prediction
`"Consequence"` in each "super population"
(*i.e.*, each level of the `"super_pop"` phenotype).

<!-- Cannot split chunk options over multiple lines :'-( -->
```{r tCBPplot,  fig.width=11, fig.height=6, out.extra='angle=90', out.width='6in', out.height='11in'}
tCBPplot <- tabulateCsqByPhenotype(
    vcf = vcf, phenoCol = "super_pop", csqCol = "Consequence",
    param = tparam,
    unique = TRUE, facet = "Feature", percentage = FALSE,
    plot = TRUE) +
    ggplot2::theme(
        legend.text = ggplot2::element_text(
            size = ggplot2::rel(0.5)),
        strip.text = ggplot2::element_text(
            size = ggplot2::rel(0.5)),
        axis.text.x = ggplot2::element_text(
            angle = 270,
            hjust = 0.5),
        axis.title.y = ggplot2::element_text(
            angle = 270)
    )

tCBPplot
```

### Table (data.frame)

The same counts can also be summarised as a `data.frame` using
the option `plot=FALSE`:

```{r tCBPtableWide}
tCBPwide <- tabulateCsqByPhenotype(
        vcf = vcf, phenoCol = "super_pop", csqCol = "Consequence",
        param = tparam,
        unique = TRUE, facet = "Feature", plot = FALSE
    )
```

of which only the subset corresponding to *missense variants* is shown here:

```{r tCBPtableWideSubset, eval=FALSE}
subset(tCBPwide, Consequence == "missense_variant")
```

```{r tCBPtableWideSubsetShow, results="asis", echo=FALSE}
knitr::kable(
    x = subset(tCBPwide, Consequence == "missense_variant"),
    row.names = FALSE,
    caption = "Table of consequence by phenotype by feature in wide format")
```

## Distribution of continuous Ensembl VEP predictions

For Ensembl VEP prediction on a continuous scale, it may be desirable to
visualise the distribution of values as a density plot:

```{r dCBPplot, warning=FALSE}
densityCsqByPhenotype(
        vcf = vcf, phenoCol = "super_pop", csqCol = "CADD_PHRED",
        param = tparam,
        unique = TRUE, facet = "Feature", plot = TRUE, popFreq = FALSE)
```


# Session info

Here is the output of `sessionInfo()` on the system on which this document was
compiled:

```{r sessionInfo, echo=FALSE}
sessionInfo()
```

# References

[R]: http://r-project.org
[RStudio]: http://www.rstudio.com/
